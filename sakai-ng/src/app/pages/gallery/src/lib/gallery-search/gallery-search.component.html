<p-toast />
<div class="card">
    <div class="header-container">
        <div class="flex align-items-center gap-2 mb-3 flex-wrap">
            <button
                pButton
                icon="pi pi-arrow-left"
                label="Back"
                (click)="goBack()"
                [hidden]="navigationStack.length === 0">
            </button>

            <span class="font-semibold text-lg">üìÇ Explorer</span>

            <!-- Multi-select controls -->
            <div class="flex gap-2 ml-auto">
                <!-- N√∫t b·∫≠t ch·∫ø ƒë·ªô ch·ªçn -->
                <p-button
                    *ngIf="!multiSelectMode"
                    icon="pi pi-check-square"
                    label="X√≥a"
                    (click)="toggleMultiSelect()"
                    class="p-button-outlined">
                </p-button>

                <!-- Controls khi ƒëang ·ªü ch·∫ø ƒë·ªô ch·ªçn -->
                <ng-container *ngIf="multiSelectMode">
                    <p-button icon="pi pi-check" label="Ch·ªçn t·∫•t c·∫£" (click)="selectAll()" class="p-button-text"></p-button>
                    <p-button icon="pi pi-times" label="H·ªßy" severity="secondary" (click)="toggleMultiSelect()" class="p-button-text"></p-button>
                    <p-button
                        icon="pi pi-trash"
                        label="X√≥a ({{ selectedItems.length }})"
                        severity="danger"
                        (click)="confirmDelete()"
                        [disabled]="selectedItems.length === 0 || deleteInProgress"
                        [loading]="deleteInProgress">
                    </p-button>
                </ng-container>

                <!-- T·∫°o th∆∞ m·ª•c & Upload (gi·ªØ nguy√™n v·ªã tr√≠ b√™n ph·∫£i) -->
                <p-button
                    icon="pi pi-folder-plus"
                    label="T·∫°o th∆∞ m·ª•c"
                    severity="success"
                    (click)="openCreateFolderDialog()"
                    class="p-button-outlined">
                </p-button>

                <p-fileUpload
                    mode="basic"
                    name="galleryFiles[]"
                    chooseLabel="Upload ·∫£nh/video"
                    accept="image/*,video/*"
                    [multiple]="true"
                    [auto]="true"
                    customUpload="true"
                    (uploadHandler)="uploadFiles($event)">
                </p-fileUpload>
            </div>
        </div>
    </div>


    <!-- Grid items -->
    <div class="grid">
        <div
            class="item relative cursor-pointer"
            *ngFor="let item of currentItems"
            (click)="openItem(item)">

            <!-- Checkbox ch·ªâ hi·ªán khi multiSelectMode = true -->
            <div *ngIf="multiSelectMode" class="absolute top-2 right-2 z-10 bg-white/80 rounded-full p-1 shadow-md">
                <p-checkbox
                    [binary]="true"
                    [ngModel]="isSelected(item)"
                    (ngModelChange)="toggleSelection(item)"
                    [inputId]="'chk-' + item.id">
                </p-checkbox>
            </div>

            <!-- Overlay nh·∫π khi item ƒë∆∞·ª£c ch·ªçn -->
            <div *ngIf="multiSelectMode && isSelected(item)"
                 class="absolute inset-0 bg-blue-500/15 rounded-lg pointer-events-none"></div>

            <i *ngIf="item.type === 'FOLDER'" class="pi pi-folder folder-icon"></i>
            <img *ngIf="item.type === 'IMAGE'" [src]="item.url" loading="lazy" class="thumb" />
            <video *ngIf="item.type === 'VIDEO'" [src]="item.url" muted class="thumb"></video>
            <div class="name">{{ item.name }}</div>
        </div>
    </div>

    <!-- Dialog t·∫°o th∆∞ m·ª•c (gi·ªØ nguy√™n) -->
    <p-dialog
        header="T·∫°o th∆∞ m·ª•c m·ªõi"
        [(visible)]="showCreateFolderDialog"
        [modal]="true"
        [style]="{ width: '420px' }"
        [draggable]="true"
        [resizable]="false">

        <div class="p-fluid">
            <div class="field mt-4">
                <label for="folderName" class="block text-lg font-medium mb-3">T√™n th∆∞ m·ª•c</label>
                <input
                    pInputText
                    id="folderName"
                    [(ngModel)]="newFolderName"
                    placeholder="Nh·∫≠p t√™n th∆∞ m·ª•c m·ªõi..."
                    class="w-full p-inputtext-lg"
                    autofocus
                    style="height: 48px; font-size: 1.1rem;"
                />
                <small class="p-error block mt-2" *ngIf="folderNameError">
                    {{ folderNameError }}
                </small>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <div class="flex justify-content-end gap-3 mt-5">
                <p-button label="H·ªßy" severity="secondary" text (click)="showCreateFolderDialog = false"></p-button>
                <p-button label="T·∫°o th∆∞ m·ª•c" icon="pi pi-check" (click)="createFolder()"></p-button>
            </div>
        </ng-template>
    </p-dialog>

    <!-- Dialog x√°c nh·∫≠n x√≥a -->
    <p-dialog
        header="X√°c nh·∫≠n x√≥a"
        [(visible)]="showDeleteConfirm"
        [modal]="true"
        [style]="{ width: '400px' }"
        [closable]="false">

        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a <strong>{{ selectedItems.length }}</strong> m·ª•c ƒë√£ ch·ªçn?</p>
        <p class="text-red-500 mt-2">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c (trong d·ªØ li·ªáu t·∫°m th·ªùi).</p>

        <ng-template pTemplate="footer">
            <p-button label="H·ªßy" severity="secondary" (click)="cancelDelete()" [disabled]="deleteInProgress"></p-button>
            <p-button label="X√≥a" severity="danger" (click)="deleteSelected()" [loading]="deleteInProgress"></p-button>
        </ng-template>
    </p-dialog>

    <!-- Preview gi·ªØ nguy√™n -->
    <app-gallery-detail
        [media]="selectedMedia"
        [(visible)]="previewVisible"
        [mediaList]="mediaList"
        [currentIndex]="currentIndex"
        (prev)="onPrev()"
        (next)="onNext()">
    </app-gallery-detail>
</div>

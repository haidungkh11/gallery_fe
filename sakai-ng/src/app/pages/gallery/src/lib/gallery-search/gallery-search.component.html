<p-toast></p-toast>

<!-- Context menu Ä‘á»•i tÃªn -->
<p-contextMenu #cm [model]="contextMenuItems"></p-contextMenu>

<div class="card">
    <!-- ================= HEADER ================= -->
    <div class="header-container">
        <!-- Row 1 -->
        <div class="header-top">
            <button
                pButton
                icon="pi pi-arrow-left"
                label="Back"
                (click)="goBack()"
                [hidden]="navigationStack.length === 0">
            </button>

            <span class="font-semibold text-lg">ðŸ“‚ ThÆ° viá»‡n áº£nh</span>
        </div>

        <!-- Row 2 -->
        <div class="header-actions">
            <p-button
                *ngIf="!multiSelectMode"
                icon="pi pi-check-square"
                label="XÃ³a"
                class="p-button-outlined"
                (click)="toggleMultiSelect()">
            </p-button>

            <ng-container *ngIf="multiSelectMode">
                <p-button
                    icon="pi pi-check"
                    label="Chá»n táº¥t cáº£"
                    class="p-button-text"
                    (click)="selectAll()">
                </p-button>

                <p-button
                    icon="pi pi-times"
                    label="Há»§y"
                    severity="secondary"
                    class="p-button-text"
                    (click)="toggleMultiSelect()">
                </p-button>

                <p-button
                    icon="pi pi-trash"
                    label="XÃ³a ({{ selectedItems.length }})"
                    severity="danger"
                    [disabled]="selectedItems.length === 0"
                    (click)="confirmDelete()">
                </p-button>
            </ng-container>

            <p-button
                icon="pi pi-folder-plus"
                label="Táº¡o thÆ° má»¥c"
                severity="success"
                class="p-button-outlined"
                (click)="openCreateFolderDialog()">
            </p-button>

            <p-fileUpload
                mode="basic"
                chooseLabel="Upload"
                name="galleryFiles[]"
                accept="image/*,video/*"
                [multiple]="true"
                [auto]="true"
                customUpload="true"
                (uploadHandler)="uploadFiles($event)">
            </p-fileUpload>
        </div>
    </div>

    <!-- ================= GRID ================= -->
    <div class="grid">
        <div
            class="item relative cursor-pointer"
            *ngFor="let item of currentItems"
            (click)="openItem(item)"
            (contextmenu)="onRightClick($event, item)"
            (touchstart)="onTouchStart(item)"
            (touchend)="onTouchEnd()">

            <!-- Checkbox -->
            <div *ngIf="multiSelectMode"
                 class="absolute top-2 right-2 z-10 bg-white/80 rounded-full p-1 shadow-md">
                <p-checkbox
                    [binary]="true"
                    [ngModel]="isSelected(item)"
                    (ngModelChange)="toggleSelection(item)">
                </p-checkbox>
            </div>

            <!-- Overlay khi chá»n -->
            <div
                *ngIf="multiSelectMode && isSelected(item)"
                class="absolute inset-0 bg-blue-500/15 rounded-lg pointer-events-none">
            </div>

            <!-- Icon / Media -->
            <i *ngIf="item.type === 'FOLDER'" class="pi pi-folder folder-icon"></i>

            <img
                *ngIf="item.type === 'IMAGE'"
                [src]="item.url"
                loading="lazy"
                class="thumb" />

            <video
                *ngIf="item.type === 'VIDEO'"
                [src]="item.url"
                muted
                class="thumb">
            </video>

            <div class="name">{{ item.name }}</div>
        </div>
    </div>

    <!-- ================= PAGINATOR ================= -->
    <p-paginator
        [rows]="pageSize"
        [totalRecords]="totalRecords"
        [rowsPerPageOptions]="[40, 80, 120]"
        (onPageChange)="onPageChange($event)"
        [hidden]="navigationStack.length === 0">
    </p-paginator>

    <!-- ================= CREATE FOLDER ================= -->
    <p-dialog
        header="Táº¡o thÆ° má»¥c má»›i"
        [(visible)]="showCreateFolderDialog"
        [modal]="true"
        [style]="{ width: '420px' }"
        [resizable]="false">

        <div class="p-fluid">
            <div class="field mt-4">
                <label class="block text-lg font-medium mb-3">TÃªn thÆ° má»¥c</label>
                <input
                    pInputText
                    [(ngModel)]="newFolderName"
                    placeholder="Nháº­p tÃªn thÆ° má»¥c..."
                    class="w-full p-inputtext-lg"
                    autofocus />
                <small class="p-error" *ngIf="folderNameError">
                    {{ folderNameError }}
                </small>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <p-button
                label="Há»§y"
                severity="secondary"
                text
                (click)="showCreateFolderDialog = false">
            </p-button>
            <p-button
                label="Táº¡o"
                icon="pi pi-check"
                (click)="createFolder()">
            </p-button>
        </ng-template>
    </p-dialog>

    <!-- ================= RENAME FOLDER ================= -->
    <p-dialog
        header="Äá»•i tÃªn thÆ° má»¥c"
        [(visible)]="showRenameDialog"
        [modal]="true"
        [style]="{ width: '420px' }">

        <div class="p-fluid">
            <div class="field mt-4">
                <label class="block font-medium mb-2">TÃªn má»›i</label>
                <input
                    pInputText
                    [(ngModel)]="renameFolderName"
                    autofocus />
            </div>
        </div>

        <ng-template pTemplate="footer">
            <p-button
                label="Há»§y"
                severity="secondary"
                text
                (click)="showRenameDialog = false">
            </p-button>
            <p-button
                label="LÆ°u"
                icon="pi pi-check"
                (click)="confirmRename()">
            </p-button>
        </ng-template>
    </p-dialog>

    <!-- ================= DELETE CONFIRM ================= -->
    <p-dialog
        header="XÃ¡c nháº­n xÃ³a"
        [(visible)]="showDeleteConfirm"
        [modal]="true"
        [closable]="false"
        [style]="{ width: '400px' }">

        <p>Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a <strong>{{ selectedItems.length }}</strong> má»¥c?</p>

        <ng-template pTemplate="footer">
            <p-button
                label="Há»§y"
                severity="secondary"
                (click)="cancelDelete()">
            </p-button>
            <p-button
                label="XÃ³a"
                severity="danger"
                (click)="deleteSelected()"
                [loading]="deleteInProgress">
            </p-button>
        </ng-template>
    </p-dialog>

    <!-- ================= PREVIEW ================= -->
    <app-gallery-detail
        [media]="selectedMedia"
        [(visible)]="previewVisible"
        [mediaList]="mediaList"
        [currentIndex]="currentIndex"
        (prev)="onPrev()"
        (next)="onNext()">
    </app-gallery-detail>
</div>
